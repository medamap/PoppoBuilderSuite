name: Performance Tests

on:
  # å®šæœŸå®Ÿè¡Œï¼ˆæ¯æ—¥æ·±å¤œ2æ™‚ JST = 17:00 UTCï¼‰
  schedule:
    - cron: '0 17 * * *'
  
  # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚
  pull_request:
    paths:
      - 'src/**'
      - 'agents/**'
      - 'test/performance/**'
      - 'package.json'
      - '.github/workflows/performance-tests.yml'
  
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      mode:
        description: 'ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰'
        required: true
        default: 'quick'
        type: choice
        options:
          - quick
          - full
      update_baseline:
        description: 'ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã‚’æ›´æ–°'
        required: false
        default: false
        type: boolean

jobs:
  performance-test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³æ¯”è¼ƒã®ãŸã‚å®Œå…¨ãªå±¥æ­´ã‚’å–å¾—
      
      - name: Node.js ${{ matrix.node-version }} ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci
      
      - name: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
        run: |
          # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’èµ·å‹•
          npm run dashboard &
          DASHBOARD_PID=$!
          echo "DASHBOARD_PID=$DASHBOARD_PID" >> $GITHUB_ENV
          
          # ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã™ã‚‹ã¾ã§å¾…æ©Ÿ
          echo "ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®èµ·å‹•ã‚’å¾…æ©Ÿä¸­..."
          for i in {1..30}; do
            if curl -s http://localhost:3001/api/health > /dev/null; then
              echo "ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãŒèµ·å‹•ã—ã¾ã—ãŸ"
              break
            fi
            sleep 1
          done
      
      - name: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆPRæ™‚ï¼‰
        if: github.event_name == 'pull_request'
        run: npm run test:performance:quick
        env:
          CI: true
          NODE_OPTIONS: --max-old-space-size=4096
      
      - name: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆå®šæœŸå®Ÿè¡Œæ™‚ï¼‰
        if: github.event_name == 'schedule'
        run: npm run test:performance
        env:
          CI: true
          NODE_OPTIONS: --max-old-space-size=4096
      
      - name: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆæ‰‹å‹•å®Ÿè¡Œæ™‚ï¼‰
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [ "${{ inputs.mode }}" = "quick" ]; then
            npm run test:performance:quick
          else
            npm run test:performance
          fi
          
          if [ "${{ inputs.update_baseline }}" = "true" ]; then
            npm run performance:baseline
          fi
        env:
          CI: true
          NODE_OPTIONS: --max-old-space-size=4096
      
      - name: ãƒ¬ãƒãƒ¼ãƒˆã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-reports-node${{ matrix.node-version }}
          path: test/performance/reports/
          retention-days: 30
      
      - name: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çµæœã‚³ãƒ¡ãƒ³ãƒˆï¼ˆPRæ™‚ï¼‰
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // æœ€æ–°ã®ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã™
            const reportDir = 'test/performance/reports';
            const files = fs.readdirSync(reportDir);
            const markdownFiles = files.filter(f => f.endsWith('.md'));
            
            if (markdownFiles.length === 0) {
              console.log('Markdownãƒ¬ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
              return;
            }
            
            // æœ€æ–°ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
            const latestFile = markdownFiles.sort().pop();
            const reportPath = path.join(reportDir, latestFile);
            const reportContent = fs.readFileSync(reportPath, 'utf8');
            
            // PRã«ã‚³ãƒ¡ãƒ³ãƒˆ
            const comment = `## ğŸš€ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆçµæœ\n\n${reportContent}`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åŠ£åŒ–ãƒã‚§ãƒƒã‚¯
        if: github.event_name == 'pull_request'
        run: |
          # ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã¨ã®æ¯”è¼ƒ
          node -e "
            const fs = require('fs');
            const path = require('path');
            
            try {
              // æœ€æ–°ã®çµæœã‚’èª­ã¿è¾¼ã¿
              const reportDir = 'test/performance/reports';
              const files = fs.readdirSync(reportDir);
              const jsonFiles = files.filter(f => f.endsWith('.json'));
              
              if (jsonFiles.length === 0) {
                console.log('JSONãƒ¬ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                process.exit(0);
              }
              
              const latestFile = jsonFiles.sort().pop();
              const resultPath = path.join(reportDir, latestFile);
              const results = JSON.parse(fs.readFileSync(resultPath, 'utf8'));
              
              // ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã‚’èª­ã¿è¾¼ã¿
              const baselinePath = path.join(reportDir, 'baseline.json');
              if (!fs.existsSync(baselinePath)) {
                console.log('ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚');
                process.exit(0);
              }
              
              const baseline = JSON.parse(fs.readFileSync(baselinePath, 'utf8'));
              
              // ä¸»è¦ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®æ¯”è¼ƒ
              let hasRegression = false;
              
              // ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆãƒã‚§ãƒƒã‚¯ï¼ˆ10%ä»¥ä¸Šã®åŠ£åŒ–ã§å¤±æ•—ï¼‰
              const currentThroughput = results.throughput?.issuesPerHour || 0;
              const baselineThroughput = baseline.results?.throughput?.issuesPerHour || 1000;
              
              if (currentThroughput < baselineThroughput * 0.9) {
                console.error(\`âŒ ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆãŒ10%ä»¥ä¸ŠåŠ£åŒ–ã—ã¦ã„ã¾ã™: \${currentThroughput} < \${baselineThroughput * 0.9}\`);
                hasRegression = true;
              }
              
              // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ ãƒã‚§ãƒƒã‚¯ï¼ˆ50%ä»¥ä¸Šã®åŠ£åŒ–ã§å¤±æ•—ï¼‰
              // TODO: å®Ÿéš›ã®å€¤ã«åŸºã¥ã„ã¦ãƒã‚§ãƒƒã‚¯
              
              if (hasRegression) {
                console.error('ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®åŠ£åŒ–ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ');
                process.exit(1);
              } else {
                console.log('âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®åŠ£åŒ–ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ');
              }
              
            } catch (error) {
              console.error('ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
              // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯è­¦å‘Šã®ã¿
            }
          "
      
      - name: ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        if: always()
        run: |
          # ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ—ãƒ­ã‚»ã‚¹ã‚’çµ‚äº†
          if [ ! -z "$DASHBOARD_PID" ]; then
            kill $DASHBOARD_PID || true
          fi

  performance-summary:
    needs: performance-test
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ãƒ¬ãƒãƒ¼ãƒˆé›†ç´„
        uses: actions/download-artifact@v4
        with:
          path: all-reports
      
      - name: ã‚µãƒãƒªãƒ¼ç”Ÿæˆ
        run: |
          echo "# ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ ã‚µãƒãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "å®Ÿè¡Œæ—¥æ™‚: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # å„Node.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®çµæœã‚’é›†ç´„
          for dir in all-reports/*/; do
            if [ -d "$dir" ]; then
              echo "## $(basename $dir)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # Markdownãƒ¬ãƒãƒ¼ãƒˆãŒã‚ã‚Œã°å†…å®¹ã‚’è¿½åŠ 
              if ls $dir/*.md 1> /dev/null 2>&1; then
                cat $dir/*.md >> $GITHUB_STEP_SUMMARY
              else
                echo "ãƒ¬ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >> $GITHUB_STEP_SUMMARY
              fi
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done