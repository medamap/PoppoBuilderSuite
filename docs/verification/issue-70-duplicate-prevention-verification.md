# Issue #70 é‡è¤‡å‡¦ç†æŠ‘åˆ¶æ©Ÿèƒ½ã®æ¤œè¨¼ãƒ¬ãƒãƒ¼ãƒˆ

**æ¤œè¨¼æ—¥**: 2025å¹´6æœˆ19æ—¥  
**æ¤œè¨¼è€…**: Claude (Issue #72ã®å®Ÿæ–½)  
**å¯¾è±¡Issue**: Issue #70ï¼ˆåŒä¸€Issueã«å¯¾ã™ã‚‹é‡è¤‡å‡¦ç†ã®æŠ‘åˆ¶ï¼‰

## ğŸ“‹ æ¤œè¨¼æ¦‚è¦

Issue #39ã§è¦æ±‚ã•ã‚Œã€Issue #70ã§å®Ÿè£…ã•ã‚ŒãŸã€ŒåŒä¸€Issueã«å¯¾ã™ã‚‹é‡è¤‡å‡¦ç†ã®æŠ‘åˆ¶æ©Ÿèƒ½ã€ãŒæ­£ã—ãå‹•ä½œã—ã¦ã„ã‚‹ã“ã¨ã‚’æ¤œè¨¼ã—ã¾ã—ãŸã€‚

## âœ… æ¤œè¨¼çµæœã‚µãƒãƒªãƒ¼

| æ¤œè¨¼é …ç›® | çµæœ | å‚™è€ƒ |
|---------|------|------|
| shouldProcessIssueé–¢æ•°ã®å‹•ä½œ | âœ… æ­£å¸¸ | è¨­è¨ˆé€šã‚Šã®å‹•ä½œã‚’ç¢ºèª |
| processedIssues Setã«ã‚ˆã‚‹é‡è¤‡é˜²æ­¢ | âœ… æ­£å¸¸ | åŒä¸€ãƒ—ãƒ­ã‚»ã‚¹å†…ã§æœ‰åŠ¹ |
| processingãƒ©ãƒ™ãƒ«ã«ã‚ˆã‚‹é‡è¤‡é˜²æ­¢ | âœ… æ­£å¸¸ | ãƒ—ãƒ­ã‚»ã‚¹é–“ã§æœ‰åŠ¹ |
| ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ï¼ˆtest-duplicate-prevention.jsï¼‰ | âœ… å…¨ã¦æˆåŠŸ | 6/6ãƒ†ã‚¹ãƒˆæˆåŠŸ |
| å®Ÿå‹•ä½œã®ç¢ºèª | âœ… æ­£å¸¸ | ãƒ‡ãƒ¢ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ç¢ºèª |

## ğŸ” è©³ç´°ãªæ¤œè¨¼å†…å®¹

### 1. å®Ÿè£…å†…å®¹ã®ç¢ºèª

#### 1.1 shouldProcessIssueé–¢æ•°ï¼ˆ`src/minimal-poppo.js`ï¼‰

```javascript
function shouldProcessIssue(issue) {
  // ã™ã§ã«å‡¦ç†æ¸ˆã¿ï¼ˆãƒ¡ãƒ¢ãƒªå†…Setï¼‰
  if (processedIssues.has(issue.number)) {
    return false;
  }

  // ãƒ©ãƒ™ãƒ«ãƒã‚§ãƒƒã‚¯
  const labels = issue.labels.map(l => l.name);
  
  // å‡¦ç†å¯¾è±¡ã®task:*ãƒ©ãƒ™ãƒ«ãƒªã‚¹ãƒˆ
  const taskLabels = ['task:misc', 'task:dogfooding', 'task:quality', 'task:docs', 'task:feature'];
  
  // ã„ãšã‚Œã‹ã®task:*ãƒ©ãƒ™ãƒ«ãŒå¿…è¦
  if (!labels.some(label => taskLabels.includes(label))) {
    return false;
  }

  // completed, processing, awaiting-responseãƒ©ãƒ™ãƒ«ãŒã‚ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—
  if (labels.includes('completed') || labels.includes('processing') || labels.includes('awaiting-response')) {
    return false;
  }

  return true;
}
```

**ç¢ºèªçµæœ**: 
- âœ… è¨­è¨ˆé€šã‚Šã®å®Ÿè£…ã‚’ç¢ºèª
- âœ… å‡¦ç†å¯¾è±¡ãƒ©ãƒ™ãƒ«ã«task:docsã¨task:featureãŒè¿½åŠ æ¸ˆã¿ï¼ˆIssue #95ï¼‰

#### 1.2 processIssueé–¢æ•°ã§ã®é‡è¤‡é˜²æ­¢

```javascript
async function processIssue(issue) {
  const issueNumber = issue.number;
  
  // æ—©æœŸãƒ­ãƒƒã‚¯ãƒã‚§ãƒƒã‚¯ï¼ˆIssueLockManagerï¼‰
  const existingLock = await lockManager.checkLock(issueNumber);
  if (existingLock && lockManager.isLockValid(existingLock)) {
    console.log(`âš ï¸  Issue #${issueNumber} ã¯æ—¢ã«å‡¦ç†ä¸­ã§ã™`);
    return;
  }

  // å‡¦ç†é–‹å§‹å‰ã«å‡¦ç†æ¸ˆã¿ã¨ã—ã¦è¨˜éŒ²ï¼ˆäºŒé‡èµ·å‹•é˜²æ­¢ï¼‰
  processedIssues.add(issueNumber);

  try {
    // StatusManagerã§ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
    await statusManager.checkout(issueNumber, `issue-${issueNumber}`, 'claude-cli');
    // ... å‡¦ç†å®Ÿè¡Œ ...
  } catch (error) {
    // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
    await statusManager.resetIssueStatus(issueNumber);
    processedIssues.delete(issueNumber);
  }
}
```

**ç¢ºèªçµæœ**:
- âœ… processedIssues.add()ã«ã‚ˆã‚‹å³åº§ã®è¨˜éŒ²
- âœ… ã‚¨ãƒ©ãƒ¼æ™‚ã®é©åˆ‡ãªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
- âœ… Issue #101ä»¥é™ã®å¼·åŒ–ï¼ˆIssueLockManagerã€StatusManagerï¼‰

### 2. ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®å®Ÿè¡Œçµæœ

```bash
$ node test/test-duplicate-prevention.js

ğŸ§ª é‡è¤‡å‡¦ç†æŠ‘åˆ¶æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹...

ğŸ“‹ é‡è¤‡å‡¦ç†æŠ‘åˆ¶æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ
ğŸ“‹ shouldProcessIssueé–¢æ•°ã®å‹•ä½œç¢ºèª
  âœ… processingãƒ©ãƒ™ãƒ«ãŒã‚ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹

ğŸ“‹ processedIssues Setã«ã‚ˆã‚‹é‡è¤‡é˜²æ­¢
  âœ… åŒã˜Issueç•ªå·ã¯ä¸€åº¦ã—ã‹å‡¦ç†ã•ã‚Œãªã„

ğŸ“‹ ãƒ©ãƒ™ãƒ«ã«ã‚ˆã‚‹é‡è¤‡å‡¦ç†é˜²æ­¢ãƒ•ãƒ­ãƒ¼
  âœ… Issueå‡¦ç†é–‹å§‹æ™‚ã«processingãƒ©ãƒ™ãƒ«ãŒè¿½åŠ ã•ã‚Œã‚‹
  âœ… å‡¦ç†å®Œäº†æ™‚ã«processingãƒ©ãƒ™ãƒ«ãŒå‰Šé™¤ã•ã‚Œã‚‹

ğŸ“‹ å®Ÿè¡Œä¸­ã‚¿ã‚¹ã‚¯ã®ç®¡ç†
  âœ… å®Ÿè¡Œä¸­ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã¸ã®è¿½åŠ ã¨å‰Šé™¤

ğŸ“‹ ä¸¦è¡Œå‡¦ç†ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  âœ… 30ç§’é–“éš”ã®ãƒãƒ¼ãƒªãƒ³ã‚°ã§é‡è¤‡å‡¦ç†ãŒç™ºç”Ÿã—ãªã„

ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼
  æˆåŠŸ: 6ä»¶
  å¤±æ•—: 0ä»¶
  åˆè¨ˆ: 6ä»¶

âœ¨ ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼
```

### 3. ãƒ‡ãƒ¢ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ

`test/demo-duplicate-prevention.js`ã‚’ä½œæˆã—ã€å®Ÿéš›ã®å‹•ä½œãƒ•ãƒ­ãƒ¼ã‚’ç¢ºèªï¼š

**Phase 1: åŸºæœ¬çš„ãªé‡è¤‡é˜²æ­¢**
- âœ… processedIssues Setã«ã‚ˆã‚‹åŒä¸€ãƒ—ãƒ­ã‚»ã‚¹å†…ã®é‡è¤‡é˜²æ­¢
- âœ… processingãƒ©ãƒ™ãƒ«ã«ã‚ˆã‚‹ãƒ—ãƒ­ã‚»ã‚¹é–“ã®é‡è¤‡é˜²æ­¢
- âœ… completed/awaiting-responseãƒ©ãƒ™ãƒ«ã«ã‚ˆã‚‹ã‚¹ã‚­ãƒƒãƒ—

**Phase 2: é«˜åº¦ãªé‡è¤‡é˜²æ­¢ï¼ˆIssue #101ä»¥é™ï¼‰**
- âœ… StatusManagerï¼ˆstate/issue-status.jsonï¼‰ã«ã‚ˆã‚‹çŠ¶æ…‹ç®¡ç†
- âœ… IssueLockManagerï¼ˆ.poppo/locks/ï¼‰ã«ã‚ˆã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãƒ­ãƒƒã‚¯
- âœ… ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆæ©Ÿèƒ½ã«ã‚ˆã‚‹ç”Ÿå­˜ç¢ºèª

### 4. å®Ÿç’°å¢ƒã§ã®å‹•ä½œç¢ºèª

```bash
# ç¾åœ¨ã®çŠ¶æ…‹ç¢ºèª
$ cat state/issue-status.json
{
  "issues": {},
  "lastSync": null
}

# ãƒ—ãƒ­ã‚»ã‚¹ç¢ºèª
$ ps aux | grep PoppoBuilder
poppo  43423  0.0  0.2 412207792  18160   ??  S  8:03AM  0:11.56 PoppoBuilder-Main
```

## ğŸ“Š é‡è¤‡é˜²æ­¢æ©Ÿæ§‹ã®å…¨ä½“åƒ

### 3å±¤ã®é˜²å¾¡ã‚·ã‚¹ãƒ†ãƒ 

1. **ç¬¬1å±¤: ãƒ¡ãƒ¢ãƒªå†…Setï¼ˆprocessedIssuesï¼‰**
   - åŒä¸€ãƒ—ãƒ­ã‚»ã‚¹å†…ã§ã®é«˜é€Ÿãªé‡è¤‡ãƒã‚§ãƒƒã‚¯
   - å‡¦ç†é–‹å§‹ã¨åŒæ™‚ã«è¨˜éŒ²
   - PoppoBuilderå†èµ·å‹•æ™‚ã«ã‚¯ãƒªã‚¢

2. **ç¬¬2å±¤: GitHubãƒ©ãƒ™ãƒ«**
   - `processing`: å‡¦ç†ä¸­
   - `completed`: å®Œäº†
   - `awaiting-response`: å¿œç­”å¾…ã¡
   - ãƒ—ãƒ­ã‚»ã‚¹é–“ã§ã®é‡è¤‡é˜²æ­¢
   - è¦–è¦šçš„ãªçŠ¶æ…‹ç¢ºèª

3. **ç¬¬3å±¤: ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ï¼ˆIssue #101ä»¥é™ï¼‰**
   - StatusManager: JSONãƒ™ãƒ¼ã‚¹ã®æ°¸ç¶šçš„ãªçŠ¶æ…‹ç®¡ç†
   - IssueLockManager: ãƒ—ãƒ­ã‚»ã‚¹ã‚¯ãƒ©ãƒƒã‚·ãƒ¥å¯¾å¿œã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ­ãƒƒã‚¯
   - MirinOrphanManager: å­¤å…Issue ã®è‡ªå‹•æ¤œå‡ºãƒ»ä¿®å¾©

## ğŸ¯ åŠ¹æœã¨åˆ©ç‚¹

1. **ãƒªã‚½ãƒ¼ã‚¹åŠ¹ç‡ã®å‘ä¸Š**
   - åŒã˜Issueã®é‡è¤‡å‡¦ç†ã«ã‚ˆã‚‹CPU/ãƒ¡ãƒ¢ãƒªã®ç„¡é§„ã‚’æ’é™¤
   - Claude APIã®ç„¡é§„ãªå‘¼ã³å‡ºã—ã‚’é˜²æ­¢

2. **å‡¦ç†ã®æ•´åˆæ€§**
   - ç«¶åˆçŠ¶æ…‹ï¼ˆrace conditionï¼‰ã®é˜²æ­¢
   - ä¸€è²«æ€§ã®ã‚ã‚‹å‡¦ç†çµæœ

3. **ã‚·ã‚¹ãƒ†ãƒ ã®å®‰å®šæ€§**
   - ãƒ—ãƒ­ã‚»ã‚¹æ•°ã®åˆ¶é™
   - ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã¸ã®è² è·è»½æ¸›

4. **å¯è¦–æ€§ã®å‘ä¸Š**
   - GitHubãƒ©ãƒ™ãƒ«ã«ã‚ˆã‚‹è¦–è¦šçš„ãªçŠ¶æ…‹è¡¨ç¤º
   - JSONãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚ˆã‚‹çŠ¶æ…‹ã®æ°¸ç¶šåŒ–

## ğŸ’¡ æ¨å¥¨äº‹é …

1. **é‹ç”¨é¢**
   - å®šæœŸçš„ãªçŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèªï¼ˆ`state/issue-status.json`ï¼‰
   - å­¤å…Issueã®ç›£è¦–ï¼ˆMirinOrphanManagerãŒè‡ªå‹•å®Ÿè¡Œï¼‰

2. **ä»Šå¾Œã®æ‹¡å¼µæ¡ˆ**
   - åˆ†æ•£ç’°å¢ƒå¯¾å¿œï¼ˆè¤‡æ•°ã®PoppoBuilderã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼‰
   - ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®åé›†ï¼ˆé‡è¤‡é˜²æ­¢ã®åŠ¹æœæ¸¬å®šï¼‰
   - WebUI ã§ã®çŠ¶æ…‹å¯è¦–åŒ–

## ğŸ“ çµè«–

Issue #70ã§å®Ÿè£…ã•ã‚ŒãŸé‡è¤‡å‡¦ç†æŠ‘åˆ¶æ©Ÿèƒ½ã¯ã€è¨­è¨ˆé€šã‚Šã«å‹•ä½œã—ã¦ãŠã‚Šã€åŠ¹æœçš„ã«åŒä¸€Issueã®é‡è¤‡å‡¦ç†ã‚’é˜²æ­¢ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚ç‰¹ã« Issue #101 ä»¥é™ã®å¼·åŒ–ã«ã‚ˆã‚Šã€ãƒ—ãƒ­ã‚»ã‚¹ã‚¯ãƒ©ãƒƒã‚·ãƒ¥æ™‚ã®å›å¾©æ©Ÿèƒ½ã‚‚è¿½åŠ ã•ã‚Œã€ã‚ˆã‚Šå …ç‰¢ãªã‚·ã‚¹ãƒ†ãƒ ã¨ãªã£ã¦ã„ã¾ã™ã€‚

---

**æ¤œè¨¼å®Œäº†æ—¥æ™‚**: 2025å¹´6æœˆ19æ—¥ 09:01 JST  
**æ¬¡å›æ¨å¥¨æ¤œè¨¼**: 3ãƒ¶æœˆå¾Œã¾ãŸã¯å¤§è¦æ¨¡ãªå¤‰æ›´æ™‚