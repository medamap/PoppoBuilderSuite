# PoppoBuilder Suite システムアーキテクチャ

## 核心概念

PoppoBuilder Suiteは、分散型非同期アーキテクチャを通じて、Claude Codeの能力を最大化しながらコンテキストウィンドウの使用を最小限に抑えるよう設計されています。

## システムコンポーネント

### 1. ユーザーインターフェース層

#### MCPインターフェース
- Claude Codeメインセッションからコマンドを受信
- 非同期ジョブ送信を管理
- ステータス追跡用のジョブIDを返す
- ノンブロッキング操作

#### CCGM (Claude Code ゼネラルマネージャー)
- プロジェクト設定管理
- ステータスレポート
- ユーザーインタラクション処理
- Poppoリポジトリ管理

### 2. 状態管理層

#### Poppoリポジトリ
以下を含む中央状態ストレージ：
- プロジェクト設定
- タスクキュー
- ジョブステータス
- エージェント調整データ
- ビルド成果物

構造：
```
poppo-repo/
├── config/
│   ├── system.json        # システム全体の設定
│   ├── projects/          # プロジェクト別設定
│   └── agents/            # エージェント別設定
├── status/
│   ├── jobs.json          # アクティブジョブ追跡
│   ├── queue.json         # 保留中のタスク
│   └── history/           # 完了したジョブログ
└── projects/
    └── {project-id}/
        ├── tasks/         # タスク定義
        ├── issues/        # GitHub Issueミラー
        └── artifacts/     # ビルド出力
```

### 3. 自動化層

#### 常駐CICD
- バックグラウンドプロセスとして実行
- 新しいタスクのためにPoppoリポジトリを監視
- エージェント用のClaude Codeサブプロセスを起動
- プロセスライフサイクルを管理
- ジョブキューイングとスケジューリングを処理

主要機能：
- ノンブロッキングサブプロセス実行
- プロセスヘルス監視
- リソース管理
- クラッシュ回復

#### エージェントオーケストラ

**CCPM (プロジェクトマネージャー)**
- Poppoリポジトリからプロジェクト状態を読み取る
- タスク分解を生成
- 指示書を作成
- タスクキューを更新

**CCAG (実装エージェント)**
- 実装タスクを実行
- フィーチャーブランチを作成
- プルリクエストを生成
- タスクステータスを更新

**CCRA (レビューエージェント)**
- プルリクエストをレビュー
- コード品質をチェック
- 改善提案を提供
- PRステータスを更新

**CCTA (テストエージェント)**
- テストスイートを実行
- 実装を検証
- テスト結果を報告
- 品質メトリクスを更新

**CCMA (マージエージェント)**
- マージ準備状況を評価
- PRマージを処理
- ブランチクリーンアップを管理
- プロジェクト状態を更新

## プロセスフロー

### 1. タスク送信
```
ユーザー → Claude Code → MCP → CCGM → Poppoリポジトリ
                              ↓
                         タスクキュー
```

### 2. タスク実行
```
CICD監視 → 新しいタスクを検出 → 適切なエージェントを起動
                                      ↓
                               Claudeサブプロセス
                                      ↓
                               Poppoリポジトリを更新
```

### 3. ステータス確認
```
ユーザー → "ステータス確認" → MCP → Poppoリポジトリを読む → レポートを整形
                                         ↓
                                    ユーザーに返す
```

## 主要な設計決定

### 1. 非同期実行
- MCPはジョブ送信後すぐに戻る
- 長時間実行タスクでブロックしない
- ステータス確認は別の操作

### 2. サブプロセス分離
- 各エージェントは独自のClaude Codeプロセスで実行
- 各タスクのためのクリーンなコンテキスト
- タスク間のコンテキスト汚染なし

### 3. ファイルベースの状態管理
- 状態保存にシンプルなJSONファイルを使用
- デバッグと手動介入が容易
- データベース依存なし

### 4. セルフホスティング機能
- PoppoBuilderは自身のコードベースで作業可能
- すべてのプロジェクトで同じワークフロー
- 初期段階からのドッグフーディング

## 通信パターン

### 1. エージェントからリポジトリへ
- エージェントは指定されたディレクトリからタスクを読む
- ステータスファイルに結果を書き込む
- 調整のためファイルロックを使用

### 2. CICDからエージェントへ
```javascript
// 起動パターン
const agent = spawn('claude', [
  '--dangerously-skip-permissions',
  '--print',
  JSON.stringify(instruction)
], {
  cwd: projectPath,
  detached: true
});
```

### 3. ユーザーからシステムへ
- Claude Code経由の自然言語コマンド
- 明確さのための構造化されたレスポンス
- ジョブID経由の進捗追跡

## スケーラビリティの考慮事項

### 1. 並列実行
- 複数のエージェントが同時に実行可能
- ジョブ依存関係はPoppoリポジトリで追跡
- リソース制限は設定可能

### 2. キュー管理
- 優先度ベースのタスクスケジューリング
- 依存関係解決
- リトライメカニズム

### 3. パフォーマンス最適化
- エージェントセッションごとの最小コンテキスト
- 効率的な状態更新
- プロジェクトデータの遅延読み込み