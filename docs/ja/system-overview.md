# PoppoBuilder Suite システムアーキテクチャ

## 核心概念

PoppoBuilder Suiteは、GitHub IssueとClaude CLIを統合した完全自動化タスク処理システムファミリーです。独立プロセス管理により、メインプロセスの再起動後もタスクが継続実行される設計となっています。

## システムコンポーネント

### 1. メインシステム（PoppoBuilder）

#### 中核機能
- GitHub Issue監視（5分間隔）
- ラベルベースのタスク検出（`task:misc`、`task:dogfooding`）
- Claude CLIとの統合実行
- コメント追記による継続的対話
- 独立プロセス管理

#### プロセス管理
- 独立プロセスマネージャー（PoppoBuilder再起動後もタスク継続）
- タスクキュー管理（優先度付き）
- レート制限対応
- 動的タイムアウト制御

### 2. システムファミリー

#### PoppoBuilder（ぽっぽちゃん）🚂
- メインの自動タスク処理システム
- Issue監視とClaude CLI実行
- 独立プロセス管理

#### MedamaRepair（目玉さん）👁️
- PoppoBuilder監視・自動復旧（1分ごと）
- プロセス健全性チェック
- 異常時の自動再起動

#### MeraCleaner（メラさん）🔥
- エラーコメント分析・整理（30分ごと）
- 重複エラーの統合
- エラーパターン分析

#### CCLAエージェント（クララちゃん）🤖
- エラーログ収集・自動修復（5分ごと）
- Phase 1-3実装（検出→分析→修復）
- 学習型エラーパターン認識

#### CCAGエージェント（カグラちゃん）📝
- ドキュメント生成・多言語対応
- APIドキュメント生成
- README更新

#### CCPMエージェント（ドレミちゃん）🔍
- コードレビュー・リファクタリング提案
- セキュリティ監査
- パターンベース問題検出

#### MirinOrphanManager（ミリンちゃん）🎋
- 孤児Issue検出・管理（毎時3分・33分）
- 放置Issue整理
- ステータス確認

### 3. データ構造

```
PoppoBuilderSuite/
├── config/
│   ├── config.json         # システム設定
│   └── daemon-config.json  # デーモン設定
├── .poppo/
│   ├── config.json         # 言語設定（ja/en）
│   ├── traceability.yaml   # トレーサビリティデータ
│   ├── processed-errors.json # 処理済みエラー記録
│   └── learning-data.json  # 学習データ
├── logs/
│   ├── poppo-*.log         # 一般ログ
│   ├── issue-*.log         # Issue別ログ
│   ├── processes-*.log     # プロセスログ
│   ├── running-tasks.json  # 実行中タスク状態
│   └── process-state.json  # プロセス状態
├── temp/
│   ├── instruction-*.txt   # Claude指示ファイル
│   ├── task-*.pid         # プロセスID
│   ├── task-*.status      # タスク状態
│   └── task-*.result      # 実行結果
└── messages/              # エージェント間通信
    ├── core/inbox/
    ├── ccpm/inbox/
    └── ccag/inbox/
```

## プロセスフロー

### 1. Issue処理フロー
```
GitHub Issue（ラベル付き）
        ↓
PoppoBuilder（5分間隔でポーリング）
        ↓
タスクキュー（優先度付き）
        ↓
独立プロセスマネージャー
        ↓
Claude CLI（独立プロセス）
        ↓
GitHubコメント投稿
```

### 2. コメント対話フロー
```
Issue処理完了 → awaiting-responseラベル
        ↓
ユーザーコメント追加
        ↓
PoppoBuilderが検出
        ↓
コンテキスト付きでClaude実行
        ↓
応答コメント投稿
```

### 3. エラー処理フロー
```
エラー発生 → ログ出力
        ↓
CCLAエージェントが検出（5分ごと）
        ↓
エラーパターン分析
        ↓
自動修復試行 or Issue作成
        ↓
学習データ更新
```

## 主要な設計決定

### 1. 独立プロセス管理
- タスクは独立プロセスとして実行
- PoppoBuilder再起動後も継続実行
- PIDファイルによるプロセス追跡
- 結果ファイルによる非同期結果取得

### 2. 優先度付きタスクキュー
- dogfoodingタスクは最優先（優先度100）
- 通常タスクは優先度50
- FIFO + 優先度によるスケジューリング

### 3. レート制限対応
- GitHub/Claude APIレート制限を自動管理
- エクスポネンシャルバックオフ実装
- 事前チェックによる無駄な起動防止

### 4. 動的タイムアウト
- タスクの複雑度に応じて自動調整
- 実行履歴による学習機能
- dogfoodingは十分な時間確保

### 5. エージェント分離
- 機能別に特化したエージェント
- ファイルベースメッセージング
- 水平スケーリング対応設計

## 現在の実装状況

### ✅ 実装済み機能
1. **基本機能**
   - Issue自動処理
   - 独立プロセス管理
   - コメント追記対応
   - Dogfooding自動再起動
   - 多言語対応（ja/en）

2. **高度な機能**
   - プロセス管理ダッシュボード
   - レート制限対応強化
   - 動的タイムアウト制御
   - エラーログ収集（Phase 1-3）
   - トレーサビリティ機能（Phase 1-3）
   - 通知機能（Discord/Pushover/Telegram）
   - エージェント分離アーキテクチャ

3. **運用機能**
   - マルチプロジェクト対応
   - グローバルキュー管理
   - 認証機能付きダッシュボード
   - 整合性監査機能

### 🚧 今後の拡張
- Kubernetes対応
- Webhookによるリアルタイム同期
- 機械学習による最適化

## アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────┐
│                        GitHub Issues                         │
│  ┌────────────┐ ┌────────────────┐ ┌──────────────────┐   │
│  │task:misc   │ │task:dogfooding │ │awaiting-response│   │
│  └────────────┘ └────────────────┘ └──────────────────┘   │
└──────────────────────────┬──────────────────────────────────┘
                           │
                    ┌──────▼──────┐
                    │ PoppoBuilder│
                    │   (Main)    │
                    └──────┬──────┘
                           │
         ┌─────────────────┼─────────────────┐
         │                 │                 │
    ┌────▼────┐      ┌────▼────┐      ┌────▼────┐
    │TaskQueue│      │Process  │      │Dashboard│
    │Manager  │      │Manager  │      │Server   │
    └─────────┘      └────┬────┘      └─────────┘
                          │
                ┌─────────┴─────────┐
                │                   │
          ┌─────▼─────┐      ┌─────▼─────┐
          │Independent│      │  Claude   │
          │ Process   │      │    CLI    │
          └───────────┘      └───────────┘
```