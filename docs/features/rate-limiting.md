# レート制限対応の強化

## 概要

PoppoBuilderのレート制限対応機能は、GitHub APIとClaude APIの両方のレート制限を動的に監視し、制限に達する前に適切な対処を行うことで、システムの安定性と継続稼働を実現します。

## 主な機能

### 1. GitHub APIレート制限監視

- **リアルタイム監視**: GitHub APIのレート制限状態を定期的に取得
- **事前警告**: 使用率が80%を超えると警告を表示
- **自動待機**: レート制限に達した場合、リセット時刻まで自動待機

```javascript
// GitHubRateLimiterの使用例
const githubLimiter = new GitHubRateLimiter();
const canCall = await githubLimiter.canMakeAPICalls(10);
if (!canCall) {
  await githubLimiter.waitForReset();
}
```

### 2. エクスポネンシャルバックオフ

- **段階的な遅延**: リトライごとに待機時間を指数関数的に増加
- **ジッター**: ランダムな変動を加えて、同時リトライを回避
- **最大リトライ回数**: 5回までのリトライ制限

バックオフ計算式:
```
次回遅延 = 現在の遅延 × 倍率 + ジッター
```

### 3. 優先度付きタスクキュー

- **Dogfoodingタスク優先**: `task:dogfooding`ラベル付きタスクは最高優先度
- **4段階の優先度**: DOGFOODING (100) > HIGH (75) > NORMAL (50) > LOW (25)
- **キューサイズ制限**: デフォルト100タスクまで

### 4. 統合レート制限管理

- **両API統合**: GitHub APIとClaude APIのレート制限を一元管理
- **事前チェック**: API呼び出し前にレート制限状態を確認
- **自動リトライ**: レート制限エラー時の自動バックオフとリトライ

## 設定

`config/config.json`でレート制限とタスクキューの動作を設定できます：

```json
{
  "rateLimiting": {
    "initialBackoffDelay": 1000,      // 初期バックオフ遅延（ミリ秒）
    "maxBackoffDelay": 300000,         // 最大バックオフ遅延（5分）
    "backoffMultiplier": 2,            // バックオフ倍率
    "backoffJitter": 0.1               // ジッター係数（0-10%）
  },
  "taskQueue": {
    "maxQueueSize": 100,               // 最大キューサイズ
    "priorityLevels": {
      "dogfooding": 100,
      "high": 75,
      "normal": 50,
      "low": 25
    }
  }
}
```

## アーキテクチャ

```
┌─────────────────────────────────────────────────────┐
│                  PoppoBuilder Main                   │
├─────────────────────────┬───────────────────────────┤
│                         │                           │
│   Enhanced Rate Limiter │      Task Queue          │
│  ┌──────────────────┐  │  ┌──────────────────┐   │
│  │ GitHub Limiter   │  │  │ Priority Queue   │   │
│  │ - API監視        │  │  │ - Dogfooding優先 │   │
│  │ - 自動待機       │  │  │ - 4段階優先度    │   │
│  └──────────────────┘  │  └──────────────────┘   │
│  ┌──────────────────┐  │  ┌──────────────────┐   │
│  │ Claude Limiter   │  │  │ Queue Events     │   │
│  │ - エラー解析     │  │  │ - Enqueued       │   │
│  │ - 待機管理       │  │  │ - Started        │   │
│  └──────────────────┘  │  │ - Completed      │   │
│  ┌──────────────────┐  │  └──────────────────┘   │
│  │ Backoff Strategy │  │                           │
│  │ - 指数関数遅延   │  │                           │
│  │ - ジッター追加   │  │                           │
│  └──────────────────┘  │                           │
└─────────────────────────┴───────────────────────────┘
```

## 動作フロー

1. **Issue/コメント検出**
   - 定期的にGitHub APIをチェック
   - レート制限状態を事前確認

2. **タスクエンキュー**
   - 優先度を判定してキューに追加
   - Dogfoodingタスクは最優先

3. **タスク処理**
   - キューから優先度順にデキュー
   - レート制限チェック
   - 制限中はタスクをキューに戻す

4. **エラーハンドリング**
   - レート制限エラー検出
   - エクスポネンシャルバックオフ
   - 自動リトライ（最大5回）

## テスト方法

レート制限機能のテストスクリプトを実行：

```bash
node test/test-rate-limiting.js
```

テスト内容：
- GitHub APIレート制限の取得
- エクスポネンシャルバックオフの計算
- タスクキューの優先度管理
- 統合レート制限チェック

## モニタリング

### ログ出力

レート制限関連のログは以下の形式で出力されます：

```
⚠️  GitHub APIレート制限警告: 85.2% 使用中 (4260/5000)
⏳ バックオフ待機 (rate limit error): 2000ms (リトライ 2/5)
🎸 レート制限中: GITHUB API
📥 タスクをキューに追加: task-123 (優先度: DOGFOODING)
```

### ダッシュボード統合

プロセス管理ダッシュボード（http://localhost:3001）で以下を確認可能：
- 現在のキューサイズ
- 優先度別タスク数
- レート制限状態

## トラブルシューティング

### Q: GitHub APIレート制限エラーが頻発する

A: 以下を確認してください：
1. GitHub Personal Access Tokenが正しく設定されているか
2. 他のアプリケーションが同じトークンを使用していないか
3. ポーリング間隔を長くする（config.json の polling.interval）

### Q: タスクがキューに溜まり続ける

A: 以下の対処を試してください：
1. 最大同時実行数を増やす（config.json の claude.maxConcurrent）
2. キューの状態を確認（ダッシュボードまたはログ）
3. レート制限が頻繁に発生していないか確認

### Q: Dogfoodingタスクが優先されない

A: タスクに `task:dogfooding` ラベルが正しく付いているか確認してください。

## 今後の拡張予定

- **Phase 2**: APIコール数の予測と事前制御
- **Phase 3**: 複数のGitHubトークンによる負荷分散
- **Phase 4**: Claude API使用量の最適化アルゴリズム