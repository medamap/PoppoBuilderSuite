# Issue #26: 動的タイムアウト制御

## 概要
タイムアウト管理の動的制御機能。従来の24時間固定タイムアウトを、タスクの種類や複雑度に応じて動的に調整する機能を実装。

## 実装日
2025年6月16日

## 実装内容

### 1. タイムアウトコントローラー
`src/timeout-controller.js`：
- タスク複雑度の自動判定アルゴリズム
  - 本文長、コードブロック数、リンク数、画像数などを分析
  - simple/moderate/complexの3段階で判定
- タスクタイプ別のデフォルトタイムアウト設定
- 実行履歴に基づく学習型タイムアウト調整
- タイムアウト延長リクエスト機能（50%延長）

### 2. プロセスマネージャーの拡張
`src/process-manager.js`：
- TimeoutControllerの統合
- 動的タイムアウトの計算と適用
- 実行時間の記録と履歴への保存
- タイムアウト理由の詳細ログ出力

### 3. 設定ファイルの拡張
`config/config.json`：
```json
"dynamicTimeout": {
  "enabled": true,
  "minTimeout": 600000,      // 10分
  "maxTimeout": 86400000,    // 24時間
  "timeoutProfiles": {
    "misc": 1800000,         // 30分
    "dogfooding": 7200000,   // 2時間
    "documentation": 3600000, // 1時間
    "complex": 21600000,     // 6時間
    "feature": 7200000,      // 2時間
    "bug": 3600000           // 1時間
  }
}
```

### 4. 実行履歴の管理
- `logs/execution-history.json`に実行履歴を保存
- タスクタイプ別の統計情報を収集
- 成功率、平均実行時間、タイムアウト率を計算

## 複雑度判定ロジック

### 複雑度スコアの計算
```javascript
// 各要素のスコア
本文長 > 500: +1
本文長 > 1000: +2
コードブロック数 × 1
リンク数 × 0.5
画像数 × 0.5

// 判定
スコア 0-2: simple (基本タイムアウト × 0.8)
スコア 3-5: moderate (基本タイムアウト × 1.0)
スコア 6+: complex (基本タイムアウト × 2.0)
```

### 学習による調整
- 過去の実行時間の90パーセンタイルを参考に
- 設定値と実績値の中間を採用
- 最小/最大タイムアウト値で制限

## テスト結果
```bash
node test/test-timeout-controller.js

# 結果例：
# シンプルなタスク: 24分（基本30分 × 0.8）
# 複雑なタスク: 720分（基本360分 × 2.0）
# 学習後の調整: 21分（履歴15分と設定30分の中間値）
```

## 動作確認方法

### PoppoBuilder起動時の統計表示
```
✅ 動的タイムアウト機能: 有効
📊 タイムアウト統計: {
  "taskTypes": {...},
  "overallStats": {...}
}
```

### タスク処理時のログ
```
[issue-123] 動的タイムアウト: 45分
[issue-123] 理由: タスクタイプ 'dogfooding' の基本タイムアウト: 120分, 複雑度レベル 'simple' による調整: x0.8
```

## 効果
- ✅ 簡単なタスクは素早く処理（リソース効率向上）
- ✅ 複雑なタスクには十分な時間を確保
- ✅ 実行履歴による最適化
- ✅ dogfoodingタスクには適切な時間を自動設定

## 技術的なポイント
- タスクの特性を多角的に分析
- 統計的手法による学習
- 柔軟な設定と調整が可能
- 既存システムへの影響を最小化

## 成果
- リソース使用効率が向上
- タスク失敗率の低減
- 運用の最適化

## 関連ドキュメント
- **機能説明**: `docs/features/dynamic-timeout.md`
- **英語版**: `docs/features/dynamic-timeout_en.md`
- **テストコード**: `test/test-timeout-controller.js`

## 関連Issue
- Issue #23: プロセス管理ダッシュボード（タイムアウト状態の表示）
- Issue #24: レート制限対応（タイムアウトとの協調）