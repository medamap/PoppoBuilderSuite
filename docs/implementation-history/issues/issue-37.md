# Issue #37: エラーログ収集Phase 2

## 概要
エラーログ収集機能 Phase 2: 高度な分析機能の実装。Phase 1で実装した基本的なエラー検出機能を拡張し、Claudeによる高度な分析、類似エラーのグループ化、統計分析機能を実装。

## 実装日
2025年6月16日

## 実装内容

### 1. Claudeによる詳細分析機能
`agents/ccla/advanced-analyzer.js`：
- エラーの根本原因推定
- 影響範囲の評価（Critical/High/Medium/Low）
- 具体的な修正方法の提案（3つ以上）
- 再発防止策の提案
- 修正時間の見積もり
- 分析結果のキャッシュ機能
- Claude APIが利用できない場合のフォールバック分析

### 2. 類似エラーグループ化機能
`agents/ccla/error-grouper.js`：
- 類似度計算アルゴリズム
  - カテゴリ一致: 30%
  - メッセージ類似度: 40%（レーベンシュタイン距離ベース）
  - スタックトレース類似度: 30%
- 閾値0.8以上で同一グループと判定
- グループ単位でのIssue管理（重複防止）
- グループの手動分離機能
- エラーグループ統計情報

### 3. 統計分析機能
`agents/ccla/statistics.js`：
- カテゴリ別エラー発生数
- 重要度別分布
- 時間帯別発生パターン（24時間分布）
- 曜日別発生パターン
- エラートレンド分析（増加/安定/減少）
  - 7日間のデータを基に線形回帰で分析
  - 15%以上の変化でトレンドとして検出
- ピーク時間帯の特定
- インサイトの自動生成

### 4. CCLAエージェントの統合
`agents/ccla/index.js`：
- Phase 2モジュールの初期化と管理
- エラー処理フローの拡張
  1. エラーグループ化（既存グループならIssue作成スキップ）
  2. 高度な分析（新規エラーの場合）
  3. 統計更新
  4. 拡張されたIssue本文の生成
- 新しいAPIエンドポイント
  - `get-statistics`: 統計情報の取得
  - `get-analysis`: 特定エラーの分析結果取得
  - `analyze-error`: 手動でエラー分析を実行

### 5. 設定の追加
`config/config.json`：
```json
"errorLogCollection": {
  "advanced": {
    "claudeAnalysis": true,
    "groupSimilarErrors": true,
    "statisticsEnabled": true
  },
  "thresholds": {
    "groupingSimilarity": 0.8
  }
}
```

## テスト結果
`test/test-ccla-phase2.js`で機能テストを実施：
- ✅ エラーグループ化（類似度66.1%と14.0%で正しく分離）
- ✅ 統計分析（533%の増加トレンドを検出）
- ✅ フォールバック分析の動作確認
- ✅ API統計データの正常取得

## 効果
- ✅ 類似エラーの重複Issue作成が防止される
- ✅ エラーの根本原因と修正方法が明確になる
- ✅ エラー傾向の可視化により予防的対策が可能
- ✅ より具体的で実用的な修正提案が得られる

## 技術的な詳細

### 類似度計算
レーベンシュタイン距離ベースのテキスト類似度

### トレンド分析
移動平均でスムージング後、線形回帰で傾向を計算

### キャッシュ
`.poppo/analysis-cache.json`に分析結果を保存

### データ永続化
- `.poppo/error-groups.json`: エラーグループ情報
- `.poppo/error-statistics.json`: 統計データ

## 拡張されたIssue本文の例
```markdown
## エラー概要
- **カテゴリ**: Type Error
- **タイプ**: bug
- **重要度**: high
- **グループID**: ERR-GRP-001（類似エラー3件）
- **エラーハッシュ**: e605f04d

## 高度な分析結果
### 根本原因
このエラーはオブジェクトのプロパティアクセス前にnullチェックが不足していることが原因です。

### 影響範囲
- **レベル**: High
- **影響**: アプリケーションのクラッシュ
- **発生頻度**: 過去7日間で15回

### 修正方法
1. オプショナルチェイニング演算子（?.）を使用
2. 明示的なnullチェックを追加
3. デフォルト値の設定

### 再発防止策
- ESLintルールの追加（no-unsafe-optional-chaining）
- TypeScriptの導入検討
- ユニットテストの追加

## 統計情報
- **トレンド**: 増加傾向（+533%/週）
- **ピーク時間**: 14:00-15:00
- **関連エラー**: 3件
```

## 成果
- エラー分析の高度化
- 重複Issue作成の防止
- 予防的な品質改善
- 効率的なエラー対応

## 技術的なポイント
- AIによる詳細分析
- 統計的手法によるトレンド検出
- 類似度計算による効率化
- キャッシュによる高速化

## 使用方法
```bash
# エージェントモードで起動（Phase 2機能有効）
npm run start:agents

# 統計情報の確認（APIエンドポイント経由）
# CCLAエージェントにメッセージを送信: { type: 'get-statistics' }
```

## 今後の拡張予定
- より高度なエラーパターンの学習
- リアルタイムダッシュボードでの統計表示
- 類似エラーの自動マージ機能
- 予測分析（将来のエラー発生予測）

## 関連ファイル
- **高度な分析**: `agents/ccla/advanced-analyzer.js`
- **グループ化**: `agents/ccla/error-grouper.js`
- **統計分析**: `agents/ccla/statistics.js`
- **テストコード**: `test/test-ccla-phase2.js`

## 関連Issue
- Issue #30, #32: エラーログ収集Phase 1（基本機能）
- Issue #34: エラーログ収集Phase 3基本（自動修復）
- Issue #38: エラーログ収集Phase 3拡張（学習とPR作成）