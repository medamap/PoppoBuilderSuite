# プロセス管理ダッシュボード 設計書

## 作成日: 2025/6/16
## ステータス: 設計中

## 1. 概要

PoppoBuilderのプロセス管理を効率化するためのWebベースダッシュボードを実装します。
このダッシュボードにより、実行中のプロセスの監視、制御、ログ閲覧がリアルタイムで可能になります。

## 2. アーキテクチャ

### 2.1 全体構成

```
PoppoBuilderSuite/
├── dashboard/                    # ダッシュボード関連
│   ├── server/                  # バックエンドサーバー
│   │   ├── index.js            # Express + WebSocketサーバー
│   │   ├── api/                # REST APIエンドポイント
│   │   │   ├── processes.js   # プロセス管理API
│   │   │   ├── logs.js        # ログ閲覧API
│   │   │   └── system.js      # システム情報API
│   │   ├── websocket/          # WebSocket通信
│   │   │   └── handlers.js    # リアルタイム通信ハンドラー
│   │   └── monitor/            # プロセス監視
│   │       └── process-monitor.js
│   └── client/                  # フロントエンド
│       ├── index.html          # メインHTML
│       ├── css/                # スタイルシート
│       │   └── dashboard.css
│       └── js/                 # JavaScript
│           ├── app.js          # メインアプリケーション
│           ├── api.js          # API通信
│           └── websocket.js    # WebSocket通信
```

### 2.2 技術スタック

- **バックエンド**: Node.js + Express.js + WebSocket (ws)
- **フロントエンド**: Vanilla JavaScript + CSS (シンプルな実装)
- **プロセス監視**: Node.js組み込みのchild_process + psツール
- **データ保存**: ファイルベース (JSON) - 既存のPoppoBuilder設計に合わせる

## 3. 機能設計

### 3.1 プロセス監視機能

#### 3.1.1 監視対象
- PoppoBuilder-Mainプロセス
- Claude CLIプロセス（PoppoBuilderから起動されたもの）
- 関連する子プロセス

#### 3.1.2 取得情報
```javascript
{
  "processId": "issue-23-12345",
  "pid": 12345,
  "type": "claude-cli",  // "main", "claude-cli", "restart-scheduler"
  "issueNumber": 23,
  "startTime": "2025-06-16T10:00:00.000Z",
  "status": "running",  // "running", "completed", "error", "timeout"
  "metrics": {
    "cpuUsage": 45.2,    // パーセンテージ
    "memoryUsage": 256,  // MB
    "elapsedTime": 3600  // 秒
  },
  "lastOutput": "最新の出力内容...",
  "lastUpdateTime": "2025-06-16T11:00:00.000Z"
}
```

### 3.2 プロセス制御機能

#### 3.2.1 基本操作
- **停止**: プロセスの強制終了
- **再起動**: PoppoBuilder-Mainの再起動
- **ログ表示**: 特定プロセスのログ詳細表示

#### 3.2.2 安全性の考慮
- 停止操作には確認ダイアログを表示
- 重要なプロセス（PoppoBuilder-Main）の停止は特別な確認が必要
- 操作履歴の記録

### 3.3 リアルタイム更新

#### 3.3.1 WebSocket通信
- プロセス状態の変更をリアルタイムで通知
- ログの新規出力をストリーミング
- システムメトリクスの定期更新（5秒間隔）

#### 3.3.2 イベントタイプ
```javascript
// プロセス開始
{ type: "process:start", data: { processId, issueNumber, ... } }

// プロセス終了
{ type: "process:end", data: { processId, status, ... } }

// メトリクス更新
{ type: "metrics:update", data: { processId, metrics, ... } }

// ログ出力
{ type: "log:output", data: { processId, content, timestamp } }
```

## 4. UI設計

### 4.1 レイアウト

```
┌─────────────────────────────────────────────────────┐
│  PoppoBuilder Process Dashboard          [更新] [停止]│
├─────────────────────────────────────────────────────┤
│ システム状態: 正常稼働中 | 実行中: 3 | 待機: 0      │
├─────────────────────────────────────────────────────┤
│ プロセス一覧                                         │
│ ┌─────────────────────────────────────────────────┐│
│ │ #23 | Claude CLI | 実行中 | CPU: 45% | 10分     ││
│ │ [ログ] [停止]                                    ││
│ ├─────────────────────────────────────────────────┤│
│ │ Main | PoppoBuilder | 稼働中 | CPU: 5% | 2時間  ││
│ │ [再起動]                                         ││
│ └─────────────────────────────────────────────────┘│
├─────────────────────────────────────────────────────┤
│ リアルタイムログ                                     │
│ ┌─────────────────────────────────────────────────┐│
│ │ [2025-06-16 10:00:00] Issue #23 処理開始        ││
│ │ [2025-06-16 10:00:05] Claude CLI起動完了        ││
│ │ ...                                              ││
│ └─────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────┘
```

### 4.2 色分けとステータス表示
- **緑**: 正常稼働中
- **黄**: 警告（高CPU/メモリ使用率）
- **赤**: エラー/タイムアウト
- **灰**: 完了/停止

## 5. 実装計画

### Phase 1: 基本的なプロセス情報記録（今回実装）
1. プロセス情報の記録機能を`src/process-manager.js`に追加
2. プロセス状態ファイル（`logs/process-state.json`）の管理
3. 基本的なプロセス情報取得API

### Phase 2: Webダッシュボード実装
1. Express.jsサーバーの実装
2. 基本的なUIの実装
3. WebSocket通信の実装
4. リアルタイム更新機能

### Phase 3: 高度な機能
1. プロセス制御機能の実装
2. 詳細なメトリクス収集
3. ログ検索・フィルタ機能
4. アラート機能

## 6. セキュリティ考慮事項

### 6.1 アクセス制御
- ローカルホストからのみアクセス可能（デフォルト）
- 必要に応じて基本認証を追加

### 6.2 操作の制限
- 危険な操作には確認が必要
- 操作ログの記録

## 7. 設定

### 7.1 ダッシュボード設定（config/config.json に追加）
```json
{
  "dashboard": {
    "enabled": true,
    "port": 3001,
    "host": "localhost",
    "updateInterval": 5000,
    "authentication": {
      "enabled": false,
      "username": "admin",
      "password": "changeme"
    }
  }
}
```

## 8. エラーハンドリング

### 8.1 プロセス監視エラー
- プロセス情報取得失敗時は前回の情報を保持
- エラーログに記録

### 8.2 WebSocket切断
- 自動再接続機能
- 切断中はポーリングでデータ取得

## 9. テスト計画

### 9.1 単体テスト
- プロセス監視機能のテスト
- API エンドポイントのテスト

### 9.2 統合テスト
- PoppoBuilderとの連携テスト
- リアルタイム更新のテスト
- 複数プロセス同時実行時のテスト

## 10. 今後の拡張可能性

- マルチプロジェクト対応
- プロセス実行履歴の保存と分析
- パフォーマンス統計とレポート生成
- Slack/Discord通知連携