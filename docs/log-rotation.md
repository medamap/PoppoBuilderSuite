# ログローテーション機能

PoppoBuilder Suiteのログローテーション自動化機能のドキュメントです。

## 概要

ログローテーション機能は、ログファイルのサイズと保存期間を管理し、ディスク容量の圧迫を防ぎながら、必要なログを適切に保存します。

## 主な機能

### 1. サイズベースのローテーション
- 設定可能な最大ファイルサイズ（デフォルト: 100MB）
- サイズ超過時の自動ローテーション
- ローテーション時のファイル命名規則（タイムスタンプ付与）

### 2. 時間ベースのローテーション
- 日次ローテーション（日付が変わった時）
- タイムゾーン対応
- 既存の日付ベースファイル名との統合

### 3. ログ圧縮機能
- ローテーション後の自動圧縮（gzip形式）
- 圧縮レベルの設定（1-9、デフォルト: 6）
- 非同期圧縮処理によるパフォーマンス最適化
- 圧縮メタデータの保存（元サイズ、圧縮率など）

### 4. 保存期間管理
- 古いログの自動削除（デフォルト: 30日）
- 保存期間の設定可能
- アーカイブサイズの監視

### 5. ログ継続性の保証
- ローテーション中のログ欠損防止
- ファイルロックの適切な管理
- エラー時のフォールバック

## 設定

`config/config.json`で以下の設定が可能です：

```json
{
  "logRotation": {
    "enabled": true,              // ローテーション有効/無効
    "maxSize": 104857600,         // 最大ファイルサイズ（バイト）100MB
    "maxFiles": 10,               // 保持するファイル数
    "datePattern": "YYYY-MM-DD",  // 日付パターン
    "compress": true,             // 圧縮有効/無効
    "compressionLevel": 6,        // 圧縮レベル（1-9）
    "retentionDays": 30,          // 保存期間（日）
    "checkInterval": 60000,       // チェック間隔（ミリ秒）
    "archivePath": "logs/archive", // アーカイブパス
    "logLevel": "INFO"            // ログレベル（ERROR/WARN/INFO/DEBUG）
  }
}
```

## 使用方法

### 自動ローテーション

PoppoBuilderが起動すると、自動的にログローテーション機能が有効になります。設定されたチェック間隔（デフォルト: 1分）でログファイルのサイズと日付をチェックし、必要に応じてローテーションを実行します。

### 手動ローテーション

CLIコマンドを使用して手動でローテーションを実行できます：

```bash
# ログをローテーション
npm run log:rotate
# または
poppo-log-rotate rotate

# アーカイブ統計を表示
npm run log:stats
# または
poppo-log-rotate stats

# 古いアーカイブを削除
npm run log:clean
# または
poppo-log-rotate clean
```

### プログラムからの使用

```javascript
const Logger = require('./src/logger');

// ログローテーション設定付きでLoggerを初期化
const logger = new Logger('/path/to/logs', {
  enabled: true,
  maxSize: 50 * 1024 * 1024,  // 50MB
  compress: true,
  retentionDays: 14
});

// 通常のログ出力
logger.info('MyComponent', 'ログメッセージ');

// 手動ローテーション
await logger.rotate();

// アーカイブ統計の取得
const stats = await logger.getArchiveStats();
console.log(stats);

// 終了時はクローズ
logger.close();
```

## アーカイブ構造

ローテーションされたログは以下の構造で保存されます：

```
logs/
├── poppo-2025-01-01.log         # 現在のログファイル
├── issue-123-2025-01-01.log     # Issue別ログ
├── processes-2025-01-01.log     # プロセスログ
└── archive/                      # アーカイブディレクトリ
    ├── poppo-2024-12-31-2024-12-31T235959.log.gz
    ├── poppo-2024-12-31-2024-12-31T235959.meta.json
    └── ...
```

## ダッシュボード統合

ログ検索APIは自動的にアーカイブファイルも検索対象に含めます：

- 圧縮ファイル（.gz）の自動解凍
- アーカイブファイルの検索とフィルタリング
- 統計情報にアーカイブファイルを含む

## パフォーマンスへの影響

- ローテーション処理は非同期で実行
- 圧縮処理もバックグラウンドで実行
- ログ書き込みパフォーマンスへの影響は最小限

## トラブルシューティング

### ログローテーションが実行されない

1. 設定で`enabled: true`になっているか確認
2. ログファイルのサイズが`maxSize`を超えているか確認
3. ファイルシステムの権限を確認

### アーカイブファイルが削除されない

1. `retentionDays`の設定を確認
2. アーカイブディレクトリの権限を確認
3. 手動で`npm run log:clean`を実行

### 圧縮ファイルが作成されない

1. `compress: true`になっているか確認
2. ディスク容量を確認
3. Node.jsのzlibモジュールが利用可能か確認

## 注意事項

- ローテーション中も新しいログは失われません
- 圧縮ファイルはダッシュボードから透過的に検索可能
- 環境変数`POPPO_LOGROTATION_ENABLED=false`で一時的に無効化可能