<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PoppoBuilder ãƒãƒ«ãƒãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0d1117;
      color: #c9d1d9;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    h1 {
      margin-bottom: 30px;
      color: #58a6ff;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 20px;
    }
    
    .card h2 {
      font-size: 16px;
      margin-bottom: 15px;
      color: #f0f6fc;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #58a6ff;
      margin: 10px 0;
    }
    
    .stat-label {
      font-size: 14px;
      color: #8b949e;
    }
    
    .projects-section {
      margin-top: 30px;
    }
    
    .project-card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 20px;
      margin-bottom: 15px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 20px;
    }
    
    .project-info h3 {
      color: #58a6ff;
      margin-bottom: 10px;
      font-size: 18px;
    }
    
    .project-stats {
      display: flex;
      gap: 20px;
      margin-top: 10px;
    }
    
    .project-stat {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .project-stat-value {
      font-size: 20px;
      font-weight: bold;
      color: #58a6ff;
    }
    
    .project-stat-label {
      font-size: 12px;
      color: #8b949e;
      margin-top: 4px;
    }
    
    .priority-badge {
      background: #1f6feb;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .priority-high {
      background: #da3633;
    }
    
    .priority-medium {
      background: #f85149;
    }
    
    .priority-low {
      background: #3fb950;
    }
    
    .health-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .health-excellent { background: #3fb950; }
    .health-good { background: #58a6ff; }
    .health-fair { background: #f85149; }
    .health-poor { background: #da3633; }
    .health-unknown { background: #8b949e; }
    
    .queue-section {
      margin-top: 30px;
    }
    
    .queue-item {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 4px;
      padding: 12px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .queue-item-info {
      flex: 1;
    }
    
    .queue-item-project {
      font-size: 12px;
      color: #8b949e;
      margin-bottom: 4px;
    }
    
    .queue-item-issue {
      color: #f0f6fc;
      font-weight: 500;
    }
    
    .status-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .status-queued {
      background: #1f6feb;
      color: white;
    }
    
    .status-processing {
      background: #f85149;
      color: white;
    }
    
    .workers-section {
      margin-top: 30px;
    }
    
    .worker-item {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 4px;
      padding: 12px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .worker-status {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .worker-status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #3fb950;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #8b949e;
    }
    
    .error {
      background: #da3633;
      color: white;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    
    .refresh-time {
      font-size: 12px;
      color: #8b949e;
      text-align: right;
      margin-top: 20px;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    .updating {
      animation: pulse 1s infinite;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>
      ğŸš‚ PoppoBuilder ãƒãƒ«ãƒãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
    </h1>
    
    <div id="error-container"></div>
    
    <div class="dashboard-grid">
      <div class="card">
        <h2>ğŸ“Š ç·ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ•°</h2>
        <div class="stat-value" id="total-projects">-</div>
        <div class="stat-label">ç™»éŒ²æ¸ˆã¿ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</div>
      </div>
      
      <div class="card">
        <h2>ğŸ“‹ ã‚­ãƒ¥ãƒ¼ã‚¿ã‚¹ã‚¯æ•°</h2>
        <div class="stat-value" id="total-queue">-</div>
        <div class="stat-label">å‡¦ç†å¾…ã¡ã‚¿ã‚¹ã‚¯</div>
      </div>
      
      <div class="card">
        <h2>âš¡ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¯ãƒ¼ã‚«ãƒ¼</h2>
        <div class="stat-value" id="active-workers">-</div>
        <div class="stat-label">å®Ÿè¡Œä¸­ã®ãƒ¯ãƒ¼ã‚«ãƒ¼</div>
      </div>
      
      <div class="card">
        <h2>âœ… å®Œäº†ã‚¿ã‚¹ã‚¯</h2>
        <div class="stat-value" id="completed-tasks">-</div>
        <div class="stat-label">æœ¬æ—¥ã®å®Œäº†æ•°</div>
      </div>
    </div>
    
    <div class="projects-section">
      <h2>ğŸ—‚ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§</h2>
      <div id="projects-container">
        <div class="loading">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>
    
    <div class="queue-section">
      <h2>ğŸ“ ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚­ãƒ¥ãƒ¼ï¼ˆæœ€æ–°10ä»¶ï¼‰</h2>
      <div id="queue-container">
        <div class="loading">ã‚­ãƒ¥ãƒ¼æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>
    
    <div class="workers-section">
      <h2>ğŸ”§ ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒ—ãƒ­ã‚»ã‚¹</h2>
      <div id="workers-container">
        <div class="loading">ãƒ¯ãƒ¼ã‚«ãƒ¼æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>
    
    <div class="refresh-time" id="refresh-time">æœ€çµ‚æ›´æ–°: -</div>
  </div>
  
  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let ws = null;
    let reconnectTimer = null;
    let isMultiProjectMode = true;
    
    // DOMè¦ç´ 
    const elements = {
      totalProjects: document.getElementById('total-projects'),
      totalQueue: document.getElementById('total-queue'),
      activeWorkers: document.getElementById('active-workers'),
      completedTasks: document.getElementById('completed-tasks'),
      projectsContainer: document.getElementById('projects-container'),
      queueContainer: document.getElementById('queue-container'),
      workersContainer: document.getElementById('workers-container'),
      errorContainer: document.getElementById('error-container'),
      refreshTime: document.getElementById('refresh-time')
    };
    
    // ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    async function fetchData() {
      try {
        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’å–å¾—
        const projectsResponse = await fetch('/api/projects');
        const projectsData = await projectsResponse.json();
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚­ãƒ¥ãƒ¼ã‚’å–å¾—
        const queueResponse = await fetch('/api/global-queue');
        const queueData = await queueResponse.json();
        
        // ãƒ¯ãƒ¼ã‚«ãƒ¼æƒ…å ±ã‚’å–å¾—
        const workersResponse = await fetch('/api/workers');
        const workersData = await workersResponse.json();
        
        updateDashboard({
          projects: projectsData.projects || [],
          queue: queueData,
          workers: workersData.workers || []
        });
        
        clearError();
      } catch (error) {
        showError('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }
    
    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’æ›´æ–°
    function updateDashboard(data) {
      // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
      elements.totalProjects.textContent = data.projects.length;
      elements.totalQueue.textContent = data.queue?.queueSize || 0;
      elements.activeWorkers.textContent = data.workers.length;
      
      // å®Œäº†ã‚¿ã‚¹ã‚¯æ•°ã‚’è¨ˆç®—
      let totalCompleted = 0;
      if (data.queue?.statistics?.byProject) {
        Object.values(data.queue.statistics.byProject).forEach(stats => {
          totalCompleted += stats.completed || 0;
        });
      }
      elements.completedTasks.textContent = totalCompleted;
      
      // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’æ›´æ–°
      updateProjects(data.projects);
      
      // ã‚­ãƒ¥ãƒ¼ã‚’æ›´æ–°
      updateQueue(data.queue?.queue || []);
      
      // ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚’æ›´æ–°
      updateWorkers(data.workers);
      
      // æ›´æ–°æ™‚åˆ»
      elements.refreshTime.textContent = `æœ€çµ‚æ›´æ–°: ${new Date().toLocaleTimeString('ja-JP')}`;
    }
    
    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’æ›´æ–°
    function updateProjects(projects) {
      if (projects.length === 0) {
        elements.projectsContainer.innerHTML = '<div class="loading">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
        return;
      }
      
      elements.projectsContainer.innerHTML = projects.map(project => `
        <div class="project-card">
          <div class="project-info">
            <h3>
              <span class="health-indicator health-${project.health || 'unknown'}"></span>
              ${project.name}
            </h3>
            <div class="project-stats">
              <div class="project-stat">
                <div class="project-stat-value">${project.currentQueue?.queued || 0}</div>
                <div class="project-stat-label">å¾…æ©Ÿä¸­</div>
              </div>
              <div class="project-stat">
                <div class="project-stat-value">${project.currentQueue?.processing || 0}</div>
                <div class="project-stat-label">å‡¦ç†ä¸­</div>
              </div>
              <div class="project-stat">
                <div class="project-stat-value">${project.statistics?.completed || 0}</div>
                <div class="project-stat-label">å®Œäº†</div>
              </div>
              <div class="project-stat">
                <div class="project-stat-value">${project.statistics?.failed || 0}</div>
                <div class="project-stat-label">å¤±æ•—</div>
              </div>
            </div>
          </div>
          <div class="project-priority">
            <span class="priority-badge priority-${getPriorityClass(project.priority)}">
              å„ªå…ˆåº¦: ${project.priority}
            </span>
          </div>
        </div>
      `).join('');
    }
    
    // ã‚­ãƒ¥ãƒ¼ã‚’æ›´æ–°
    function updateQueue(queue) {
      if (queue.length === 0) {
        elements.queueContainer.innerHTML = '<div class="loading">ã‚­ãƒ¥ãƒ¼ã«ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      // æœ€æ–°10ä»¶ã®ã¿è¡¨ç¤º
      const displayQueue = queue.slice(0, 10);
      
      elements.queueContainer.innerHTML = displayQueue.map(task => `
        <div class="queue-item">
          <div class="queue-item-info">
            <div class="queue-item-project">${task.projectId}</div>
            <div class="queue-item-issue">Issue #${task.issueNumber}</div>
          </div>
          <span class="status-badge status-${task.status}">
            ${task.status === 'queued' ? 'å¾…æ©Ÿä¸­' : 'å‡¦ç†ä¸­'}
          </span>
        </div>
      `).join('');
    }
    
    // ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚’æ›´æ–°
    function updateWorkers(workers) {
      if (workers.length === 0) {
        elements.workersContainer.innerHTML = '<div class="loading">ç¨¼åƒä¸­ã®ãƒ¯ãƒ¼ã‚«ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      elements.workersContainer.innerHTML = workers.map(worker => `
        <div class="worker-item">
          <div class="worker-info">
            <strong>${worker.projectId}</strong>
            <div style="font-size: 12px; color: #8b949e;">PID: ${worker.pid}</div>
          </div>
          <div class="worker-status">
            <span class="worker-status-indicator"></span>
            ${worker.status}
          </div>
        </div>
      `).join('');
    }
    
    // å„ªå…ˆåº¦ã‚¯ãƒ©ã‚¹ã‚’å–å¾—
    function getPriorityClass(priority) {
      if (priority >= 80) return 'high';
      if (priority >= 50) return 'medium';
      return 'low';
    }
    
    // ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
    function showError(message) {
      elements.errorContainer.innerHTML = `<div class="error">${message}</div>`;
    }
    
    // ã‚¨ãƒ©ãƒ¼ã‚’ã‚¯ãƒªã‚¢
    function clearError() {
      elements.errorContainer.innerHTML = '';
    }
    
    // WebSocketæ¥ç¶š
    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}`;
      
      ws = new WebSocket(wsUrl);
      
      ws.onopen = () => {
        console.log('WebSocketæ¥ç¶šãŒç¢ºç«‹ã•ã‚Œã¾ã—ãŸ');
        clearError();
      };
      
      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          if (data.type === 'update' || data.type === 'initial') {
            // å˜ä¸€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ‰ã®æ›´æ–°ã®å ´åˆã¯ç„¡è¦–
            if (!isMultiProjectMode) {
              return;
            }
          }
        } catch (error) {
          console.error('WebSocketãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è§£æã‚¨ãƒ©ãƒ¼:', error);
        }
      };
      
      ws.onerror = (error) => {
        console.error('WebSocketã‚¨ãƒ©ãƒ¼:', error);
        showError('WebSocketæ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      };
      
      ws.onclose = () => {
        console.log('WebSocketæ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ');
        scheduleReconnect();
      };
    }
    
    // å†æ¥ç¶šã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
    function scheduleReconnect() {
      if (reconnectTimer) {
        clearTimeout(reconnectTimer);
      }
      reconnectTimer = setTimeout(() => {
        console.log('WebSocketå†æ¥ç¶šã‚’è©¦ã¿ã¾ã™...');
        connectWebSocket();
      }, 5000);
    }
    
    // åˆæœŸåŒ–
    async function initialize() {
      // åˆå›ãƒ‡ãƒ¼ã‚¿å–å¾—
      await fetchData();
      
      // WebSocketæ¥ç¶š
      connectWebSocket();
      
      // å®šæœŸçš„ãªãƒ‡ãƒ¼ã‚¿æ›´æ–°ï¼ˆ5ç§’ã”ã¨ï¼‰
      setInterval(fetchData, 5000);
    }
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', initialize);
  </script>
</body>
</html>